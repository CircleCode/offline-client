<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE bindings [
      <!ENTITY % leaf-attributes-bindingDTD SYSTEM "chrome://dcpoffline/locale/leaf-attributes-binding.dtd" >
      <!ENTITY separator "&#160;:&#160;" >
      <!ENTITY systemBindingsDirPath "chrome://dcpoffline/content/bindings/system" >
      %leaf-attributes-bindingDTD;
]>
<bindings id="leaf-attributes-binding" xmlns="http://www.mozilla.org/xbl" xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
    xmlns:xbl="http://www.mozilla.org/xbl" xmlns:html="http://www.w3.org/1999/xhtml"
>
    <binding id="leaf-attr-view" extends="&systemBindingsDirPath;/base-attributes.xml#base-attr">
        <implementation>
            <property name="value" onget="this.getValue();" onset="this.setValue(val);">
            </property>
            <method name="checkValue">
                <parameter name="value" />
                <body><![CDATA[
                    return value;
                ]]></body>
            </method>
            <method name="setValue">
                <parameter name="value" />
                <body><![CDATA[
                    try{
                        var value = this.checkValue(value);
                        this.doc.setValue(this.attrid, value);
                        this.reloadValue();
                        return true;
                    } catch(e){
                        Components.utils.import("resource://modules/logger.jsm");
                        logError(e);
                    }
                    return false;
                ]]></body>
            </method>
            <method name="reloadValue">
                <body><![CDATA[
                    if (this.getValue() == '') {
                       var cn=document.getAnonymousNodes(this);
                       for (var i=0;i<cn.length;i++) {
                         cn[i].style.display='none';
                       }
                    } else {
                        var valueNode = this.getChild('displayValue');
                        if(valueNode){
                           if (Array.isArray(this.getValue())) {
                             valueNode.textContent=this.getValue();
                           } else {
                            valueNode.textContent=this.getDisplayValue();
                           }
                        } else {
                           // Components.utils.import("resource://modules/exceptions.jsm");
                           // throw new BindException("no displayValue child for attr ["+ this.attrid + "] in doc ["+this.doc.initid + "]");
                        }
                    }
                ]]></body>
            </method>
            <method name="getValue">
                <body><![CDATA[
                    var index=this.getAttribute("index");
                    if ( index !== null) {
                       var val=this.doc.getValue(this.attrid);
                       if (Array.isArray(val)) {
                          return val[index];
                       } else {
                          return val;
                       }
                    } else {
                       return this.doc.getValue(this.attrid);
                    }
                ]]></body>
            </method>
            <method name="getDisplayValue">
                <body><![CDATA[
                    return this.getValue()
                ]]></body>
            </method>
            <constructor><![CDATA[
                this.reloadValue();
            ]]></constructor>
        </implementation>
    </binding>
    <!-- Text attributes -->
    <binding id="text-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute text">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
    </binding>
    <binding id="longtext-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute longtext">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" style="white-space:pre-line;">
                </xul:label>
            </xul:hbox>
        </content>
        <implementation>
        </implementation>
    </binding>
    <binding id="htmltext-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute longtext">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <html:div anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
        <implementation>
            <method name="reloadValue">
                <body><![CDATA[
                    var Cc = Components.classes;
                    var Ci = Components.interfaces;
                    
                    var valueNode = this.getChild('displayValue');
                    if(valueNode){
                        valueNode.appendChild(
                                Cc["@mozilla.org/feed-unescapehtml;1"]
                                        .getService(
                                                Ci.nsIScriptableUnescapeHTML)
                                        .parseFragment(this.getValue(),
                                                false,
                                                null,
                                                valueNode));
                    } else {
                        throw new BindingException("no displayValue chil for attr ["+ this.attrid + "] in doc ["+this.doc.initid + "]");
                    }
                ]]></body>
            </method>
        </implementation>
    </binding>
    <!-- Date attributes -->
    <binding id="htmlanchor-attr-view">
        <content> ANCHOR</content>
        <implementation>
            <field name="link"><![CDATA[
                this.getAttribute('link')
            ]]></field>
            <constructor><![CDATA[
                this.setAttribute('title',this.href);
                var href=this.href;
                this.setAttribute('href','javascript:void(0)');
                this.setAttribute('link',href);
                
            ]]></constructor>
        </implementation>
        <handlers>
            <handler event="click" button="0"><![CDATA[
                if(this.link!=''){
                   
                    // first construct an nsIURI object using the ioservice
                    var ioservice = Components.classes["@mozilla.org/network/io-service;1"]
                                              .getService(Components.interfaces.nsIIOService);
                    
                    var uriToOpen = ioservice.newURI(this.link, null, null);
                    
                    var extps = Components.classes["@mozilla.org/uriloader/external-protocol-service;1"]
                                          .getService(Components.interfaces.nsIExternalProtocolService);
                    
                    // now, open it!
                    extps.loadURI(uriToOpen);
                    
                }
            ]]></handler>
        </handlers>
    </binding>
    <!-- Numeric attributes -->
    <binding id="int-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute int">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue plain" />
            </xul:hbox>
        </content>
    </binding>
    <binding id="double-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute double">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue plain" />
            </xul:hbox>
        </content>
    </binding>
    <binding id="money-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute money">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
    </binding>
    <binding id="time-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute time">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
    </binding>
    <!-- Date attributes -->
    <binding id="date-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute date">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
        <implementation>
            <method name="getDisplayValue">
                <body><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            return formater.getLocaleDate(this.getValue());
                ]]></body>
            </method>
        </implementation>
    </binding>
    <!-- Relation attributes -->
    <binding id="docid-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
        <implementation>
            <field name="displayValue"><![CDATA[
                this.getChild('displayValue');
            ]]></field>
            <field name="docid"><![CDATA[
                this.getValue();
            ]]></field>
            <method name="openDoc">
                <body><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            
            
            try {
              var rdoc=docManager.getLocalDocument({initid:this.docid});
              if (rdoc) {
                tryToOpenDocument({documentId:this.docid});
              }
            } catch (e) {}
                ]]></body>
            </method>
            <constructor><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            Components.utils.import("resource://modules/docManager.jsm");
            var valueNode = this.getChild('displayValue');
            
            var docid=this.getValue();
            var title=formater.getDocumentTitle({initid:docid});
            
            valueNode.value=title;
            try {
              var rdoc=docManager.getLocalDocument({initid:docid});
              if (rdoc) {
                valueNode.classList.add('link');
              }
            } catch (e) {}
            
            ]]>
            </constructor>
        </implementation>
        <handlers>
            <handler event="click" button="0"><![CDATA[
                if(event.originalTarget == this.displayValue){
                    this.openDoc();
                }
            ]]></handler>
        </handlers>
    </binding>
    <binding id="docid-multiple-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:grid flex="1" inherited="attrid">
                    <xul:columns anonid="columns" />
                    <xul:rows anonid="rows" />
                </xul:grid>
            </xul:hbox>
        </content>
        <implementation>
            <constructor><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            
            var docids=this.getValue();
            var rows=this.getChild('rows');
            for (var i=0;i<docids.length; i++) {
               var clo=this.cloneNode(false);
               clo.setAttribute("multiple", "false");
               clo.setAttribute("index", i);
               rows.appendChild(clo);
            }
            ]]>
            </constructor>
        </implementation>
    </binding>
    <!-- Enum attributes -->
    <binding id="enum-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="displayValue" class="dcpValue" />
            </xul:hbox>
        </content>
        <implementation>
            <method name="getDisplayValue">
                <body><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            return formater.getEnumLabel({attrid:this.attrid,famid:this.doc.getProperty('fromid'),key:this.getValue()});
                ]]></body>
            </method>
        </implementation>
    </binding>
    <binding id="enum-multiple-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:grid flex="1" inherited="attrid">
                    <xul:columns anonid="columns" />
                    <xul:rows anonid="rows" />
                </xul:grid>
            </xul:hbox>
        </content>
        <implementation>
            <constructor><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            
            var docids=this.getValue();
            var rows=this.getChild('rows');
            for (var i=0;i<docids.length; i++) {
               var clo=this.cloneNode(false);
               clo.setAttribute("multiple", "false");
               clo.setAttribute("index", i);
               rows.appendChild(clo);
            }
            ]]>
            </constructor>
        </implementation>
    </binding>
    <!-- file attributes -->
    <binding id="file-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <xul:label anonid="fileName" class="dcpValue plain" value="FILE NOT YET IMPLEMENTED" />
            </xul:hbox>
        </content>
        <implementation>
            <field name="fileName"><![CDATA[
                this.getChild('fileName');
            ]]></field>
            <method name="openFile">
                <body><![CDATA[
                    Components.utils.import("resource://modules/fileManager.jsm");
                    fileManager.openFile({
                        initid: this.doc.getInitid(),
                        attrid: this.attrid,
                        index: this.getAttribute('index')
                    });
                ]]></body>
            </method>
            <constructor><![CDATA[
            Components.utils.import("resource://modules/formater.jsm");
            Components.utils.import("resource://modules/docManager.jsm");
            Components.utils.import("resource://modules/fileManager.jsm");
                Components.utils.import("resource://modules/logger.jsm");
            var valueNode = this.getChild('fileName');
            var docid=this.doc.getInitid();
            var lfile=fileManager.getFile({initid:docid, attrid:this.attrid, index:this.getAttribute('index')});
            if (lfile) {
              var title=lfile.leafName;
              logConsole("test file", lfile);
              valueNode.value=title;
              
              valueNode.classList.add('link');
            } 
            
            ]]>
            </constructor>
        </implementation>
        <handlers>
            <handler event="click" button="0"><![CDATA[
               
                if(event.originalTarget == this.fileName){
                    this.openFile();
                }
            ]]></handler>
        </handlers>
    </binding>
    <binding id="image-attr-view" extends="&systemBindingsDirPath;/leaf-attributes-view.xml#leaf-attr-view">
        <content>
            <xul:hbox xbl:inherits="attrid" flex="1" class="dcpAttribute docid">
                <xul:label anonid="label" class="dcpLabel" xbl:inherits="value=label" />
                <xul:label anonid="separator" class="dcpSeparator" value="&separator;" />
                <html:div class="dcpValue">
                    <html:img class="dcpImage" anonid="fileName" />
                </html:div>
            </xul:hbox>
        </content>
        <implementation>
            <field name="fileName"><![CDATA[
                this.getChild('fileName');
            ]]></field>
            <method name="openFile">
                <body><![CDATA[
                    Components.utils.import("resource://modules/fileManager.jsm");
                    fileManager.openFile({
                        initid: this.doc.getInitid(),
                        attrid: this.attrid,
                        index: this.getAttribute('index')
                    });
                ]]></body>
            </method>
            <constructor><![CDATA[
            Components.utils.import("resource://modules/fileManager.jsm");
                Components.utils.import("resource://modules/logger.jsm");
            var valueNode = this.getChild('fileName');
            var docid=this.doc.getInitid();
            var lfile=fileManager.getFile({initid:docid, attrid:this.attrid, index:this.getAttribute('index')});
            if (lfile) {
              var title=lfile.leafName;
              valueNode.title=title;
              valueNode.classList.add('link');
              valueNode.src='file://'+lfile.path;
            } else {
              valueNode.style.display='none';
            }
            
            ]]>
            </constructor>
        </implementation>
        <handlers>
            <handler event="click" button="0"><![CDATA[
               
                if(event.originalTarget == this.fileName){
                    this.openFile();
                }
            ]]></handler>
        </handlers>
    </binding>
</bindings>